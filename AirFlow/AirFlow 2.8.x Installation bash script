#!/bin/bash
set -euo pipefail

# Configuration
AIRFLOW_VERSION="2.8.1"
PYTHON_VERSION="3.9"
POSTGRES_VERSION="15"
AIRFLOW_USER="airflow"
AIRFLOW_PASSWORD="airflow_secure_password"  # Change this
ADMIN_PASSWORD="admin_secure_password"       # Change this

# Check if running as root
if [[ $EUID -eq 0 ]]; then
   echo "This script should NOT be run as root. Run with sudo privileges." 
   exit 1
fi

echo "=== Starting Airflow Installation ==="

# Update system and install dependencies
sudo dnf update -y
sudo dnf install -y gcc openssl-devel bzip2-devel libffi-devel libpq-devel \
    python39-devel wget firewalld

# Install Python 3.9
sudo dnf module install -y python39
python3.9 --version

# Create virtual environment
python3.9 -m venv ~/airflow-venv
source ~/airflow-venv/bin/activate

# Set environment variables
export AIRFLOW_HOME=~/airflow
echo "export AIRFLOW_HOME=$AIRFLOW_HOME" >> ~/.bashrc
echo "source ~/airflow-venv/bin/activate" >> ~/.bashrc

# Install PostgreSQL 15
sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo dnf -qy module disable postgresql
sudo dnf install -y postgresql15-server postgresql15-contrib

# Initialize PostgreSQL
sudo /usr/pgsql-15/bin/postgresql-15-setup initdb
sudo systemctl enable postgresql-15
sudo systemctl start postgresql-15

# Configure PostgreSQL authentication
sudo sed -i 's/ident/md5/g' /var/lib/pgsql/15/data/pg_hba.conf
sudo systemctl reload postgresql-15

# Create Airflow database
sudo -u postgres psql -c "CREATE DATABASE airflow_db;"
sudo -u postgres psql -c "CREATE USER $AIRFLOW_USER WITH PASSWORD '$AIRFLOW_PASSWORD';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE airflow_db TO $AIRFLOW_USER;"

# Install Airflow with PostgreSQL support
CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
pip install "apache-airflow[postgres]==${AIRFLOW_VERSION}" --constraint "${CONSTRAINT_URL}"

# Configure Airflow
sed -i "s|sql_alchemy_conn = .*|sql_alchemy_conn = postgresql+psycopg2://$AIRFLOW_USER:$AIRFLOW_PASSWORD@localhost/airflow_db|g" \
    $AIRFLOW_HOME/airflow.cfg
sed -i 's/executor = .*/executor = LocalExecutor/g' $AIRFLOW_HOME/airflow.cfg

# Initialize database
airflow db init

# Create admin user
airflow users create \
    --username admin \
    --firstname Admin \
    --lastname User \
    --role Admin \
    --email admin@example.com \
    --password "$ADMIN_PASSWORD"

# Configure firewall
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload

# Create systemd services
CURRENT_USER=$(whoami)
SERVICE_DIR="/etc/systemd/system"
VENV_PATH="$HOME/airflow-venv/bin/airflow"

# Webserver service
sudo tee $SERVICE_DIR/airflow-webserver.service > /dev/null <<EOF
[Unit]
Description=Airflow Webserver
After=network.target postgresql-15.service

[Service]
User=$CURRENT_USER
Group=$CURRENT_USER
Environment="AIRFLOW_HOME=$AIRFLOW_HOME"
ExecStart=$VENV_PATH webserver --port 8080
Restart=always
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

# Scheduler service
sudo tee $SERVICE_DIR/airflow-scheduler.service > /dev/null <<EOF
[Unit]
Description=Airflow Scheduler
After=network.target postgresql-15.service

[Service]
User=$CURRENT_USER
Group=$CURRENT_USER
Environment="AIRFLOW_HOME=$AIRFLOW_HOME"
ExecStart=$VENV_PATH scheduler
Restart=always
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

# Reload and enable services
sudo systemctl daemon-reload
sudo systemctl enable airflow-webserver airflow-scheduler
sudo systemctl start airflow-webserver airflow-scheduler

echo "=== Installation Complete ==="
echo "Airflow UI: http://$(curl -s ifconfig.me):8080"
echo "Admin username: admin"
echo "Admin password: $ADMIN_PASSWORD"